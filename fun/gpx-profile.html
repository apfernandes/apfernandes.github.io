<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GPX Altitude Profile Analyzer</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #e0e0e0;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-weight: 300;
            font-size: 2.5rem;
            color: #fff;
            text-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .upload-zone {
            border: 2px dashed #4a5568;
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
            background: rgba(255,255,255,0.03);
            cursor: pointer;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }

        .upload-zone input {
            display: none;
        }

        .upload-zone label {
            cursor: pointer;
            display: block;
        }

        .upload-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .upload-text {
            font-size: 1.1rem;
            color: #a0aec0;
        }

        .upload-text span {
            color: #667eea;
            text-decoration: underline;
        }

        .files-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
            justify-content: center;
        }

        .file-tag {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .file-tag .remove {
            cursor: pointer;
            opacity: 0.7;
            transition: opacity 0.2s;
        }

        .file-tag .remove:hover {
            opacity: 1;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }

        @media (max-width: 1000px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }

        .chart-container, .map-container {
            background: rgba(255,255,255,0.05);
            border-radius: 16px;
            padding: 20px;
            position: relative;
        }

        .section-title {
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #a0aec0;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chart-wrapper {
            position: relative;
            height: 350px;
        }

        #map {
            height: 350px;
            border-radius: 12px;
            z-index: 1;
        }

        .instructions {
            text-align: center;
            padding: 20px;
            color: #a0aec0;
            font-size: 0.95rem;
        }

        .selection-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .info-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .info-card h3 {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #a0aec0;
            margin-bottom: 8px;
        }

        .info-card .value {
            font-size: 1.8rem;
            font-weight: 600;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .info-card .unit {
            font-size: 0.85rem;
            color: #a0aec0;
        }

        .info-card .sub-value {
            font-size: 0.9rem;
            color: #a0aec0;
            margin-top: 4px;
        }

        .grade-indicator {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            margin-top: 8px;
        }

        .grade-flat { background: #48bb78; color: #fff; }
        .grade-moderate { background: #ecc94b; color: #1a1a2e; }
        .grade-steep { background: #ed8936; color: #fff; }
        .grade-extreme { background: #f56565; color: #fff; }

        .clear-btn {
            display: block;
            margin: 20px auto 0;
            padding: 12px 30px;
            background: transparent;
            border: 2px solid #667eea;
            color: #667eea;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .clear-btn:hover {
            background: #667eea;
            color: #fff;
        }

        .legend {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            justify-content: center;
            margin-top: 15px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.85rem;
            color: #a0aec0;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 3px;
        }

        .no-data {
            text-align: center;
            padding: 60px 20px;
            color: #718096;
        }

        .map-placeholder {
            height: 350px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            color: #718096;
            flex-direction: column;
            gap: 10px;
        }

        .map-placeholder svg {
            width: 60px;
            height: 60px;
            opacity: 0.5;
        }

        /* Custom Leaflet styles */
        .leaflet-container {
            background: #1a1a2e;
        }

        .custom-marker {
            background: #667eea;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .start-marker {
            background: #48bb78;
        }

        .end-marker {
            background: #f56565;
        }

        .selected-marker {
            background: #ffd700;
            border: 3px solid #fff;
            border-radius: 50%;
            box-shadow: 0 2px 10px rgba(0,0,0,0.5);
        }

        .hover-marker {
            background: #fff;
            border: 2px solid #667eea;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üèîÔ∏è GPX Altitude Profile Analyzer</h1>

        <div class="upload-zone" id="dropZone">
            <input type="file" id="fileInput" multiple accept=".gpx">
            <label for="fileInput">
                <div class="upload-icon">üìÅ</div>
                <div class="upload-text">
                    Drag & drop GPX files here or <span>browse</span>
                </div>
            </label>
            <div class="files-list" id="filesList"></div>
        </div>

        <div class="main-content">
            <div class="chart-container">
                <div class="section-title">üìà Elevation Profile</div>
                <div class="chart-wrapper">
                    <canvas id="altitudeChart"></canvas>
                </div>
                <div class="instructions" id="instructions">
                    Upload GPX files to see the altitude profile.
                </div>
                <div class="legend" id="legend"></div>
            </div>

            <div class="map-container">
                <div class="section-title">üó∫Ô∏è Route Map</div>
                <div id="mapWrapper">
                    <div class="map-placeholder" id="mapPlaceholder">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                            <path d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l5.447 2.724A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                        </svg>
                        <span>Map will appear here</span>
                    </div>
                    <div id="map" style="display: none;"></div>
                </div>
            </div>
        </div>

        <div class="selection-info" id="selectionInfo" style="display: none;">
            <div class="info-card">
                <h3>Point 1</h3>
                <div class="value" id="point1Dist">-</div>
                <div class="unit">km</div>
                <div class="sub-value"><span id="point1Alt">-</span> m elevation</div>
            </div>
            <div class="info-card">
                <h3>Point 2</h3>
                <div class="value" id="point2Dist">-</div>
                <div class="unit">km</div>
                <div class="sub-value"><span id="point2Alt">-</span> m elevation</div>
            </div>
            <div class="info-card">
                <h3>Distance</h3>
                <div class="value" id="distanceBetween">-</div>
                <div class="unit">km</div>
            </div>
            <div class="info-card">
                <h3>Elevation Change</h3>
                <div class="value" id="elevationChange">-</div>
                <div class="unit">m</div>
            </div>
            <div class="info-card">
                <h3>Average Grade</h3>
                <div class="value" id="averageGrade">-</div>
                <div class="unit">%</div>
                <div class="grade-indicator" id="gradeIndicator"></div>
            </div>
        </div>

        <button class="clear-btn" id="clearSelection" style="display: none;">Clear Selection</button>
    </div>

    <script>
        const colors = [
            '#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a',
            '#fee140', '#30cfd0', '#a8edea', '#ff9a9e', '#fbc2eb'
        ];

        let chart = null;
        let map = null;
        let gpxData = [];
        let selectedPoints = [];
        let mapLayers = [];
        let selectedMarkers = [];
        let hoverMarker = null;
        let highlightedSegment = null;

        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const filesList = document.getElementById('filesList');
        const instructions = document.getElementById('instructions');
        const legend = document.getElementById('legend');
        const selectionInfo = document.getElementById('selectionInfo');
        const clearBtn = document.getElementById('clearSelection');
        const mapPlaceholder = document.getElementById('mapPlaceholder');
        const mapDiv = document.getElementById('map');

        // Drag and drop handlers
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.add('dragover'));
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => dropZone.classList.remove('dragover'));
        });

        dropZone.addEventListener('drop', handleDrop);
        fileInput.addEventListener('change', handleFileSelect);

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            handleFiles(files);
        }

        function handleFileSelect(e) {
            const files = e.target.files;
            handleFiles(files);
        }

        function handleFiles(files) {
            Array.from(files).forEach(file => {
                if (file.name.endsWith('.gpx')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        parseGPX(e.target.result, file.name);
                    };
                    reader.readAsText(file);
                }
            });
        }

        function parseGPX(content, filename) {
            const parser = new DOMParser();
            const xmlDoc = parser.parseFromString(content, 'text/xml');
            
            const trackPoints = xmlDoc.querySelectorAll('trkpt');
            if (trackPoints.length === 0) return;

            const points = [];
            let totalDistance = 0;
            let prevLat = null, prevLon = null;

            trackPoints.forEach((pt, index) => {
                const lat = parseFloat(pt.getAttribute('lat'));
                const lon = parseFloat(pt.getAttribute('lon'));
                const eleNode = pt.querySelector('ele');
                const ele = eleNode ? parseFloat(eleNode.textContent) : 0;

                if (prevLat !== null) {
                    totalDistance += haversineDistance(prevLat, prevLon, lat, lon);
                }

                points.push({
                    distance: totalDistance,
                    elevation: ele,
                    lat: lat,
                    lon: lon
                });

                prevLat = lat;
                prevLon = lon;
            });

            gpxData.push({
                name: filename.replace('.gpx', ''),
                points: points,
                color: colors[gpxData.length % colors.length]
            });

            updateFilesList();
            updateChart();
            updateMap();
        }

        function haversineDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Earth's radius in km
            const dLat = toRad(lat2 - lat1);
            const dLon = toRad(lon2 - lon1);
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                      Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                      Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function toRad(deg) {
            return deg * Math.PI / 180;
        }

        function updateFilesList() {
            filesList.innerHTML = gpxData.map((data, index) => `
                <div class="file-tag" style="background: linear-gradient(135deg, ${data.color} 0%, ${data.color}99 100%);">
                    ${data.name}
                    <span class="remove" onclick="removeFile(${index})">‚úï</span>
                </div>
            `).join('');
        }

        function removeFile(index) {
            gpxData.splice(index, 1);
            gpxData.forEach((data, i) => {
                data.color = colors[i % colors.length];
            });
            updateFilesList();
            updateChart();
            updateMap();
            clearSelection();
        }

        function initMap() {
            if (map) return;
            
            mapPlaceholder.style.display = 'none';
            mapDiv.style.display = 'block';
            
            map = L.map('map', {
                zoomControl: true,
                attributionControl: true
            }).setView([0, 0], 2);

            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
        }

        function updateMap() {
            if (gpxData.length === 0) {
                if (map) {
                    mapDiv.style.display = 'none';
                    mapPlaceholder.style.display = 'flex';
                }
                return;
            }

            initMap();

            // Clear existing layers
            mapLayers.forEach(layer => map.removeLayer(layer));
            mapLayers = [];

            const allBounds = [];

            gpxData.forEach((track, trackIndex) => {
                const coordinates = track.points.map(p => [p.lat, p.lon]);
                
                // Add track polyline
                const polyline = L.polyline(coordinates, {
                    color: track.color,
                    weight: 4,
                    opacity: 0.8
                }).addTo(map);
                mapLayers.push(polyline);

                // Add start marker
                const startIcon = L.divIcon({
                    className: 'custom-marker start-marker',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                const startMarker = L.marker(coordinates[0], { icon: startIcon })
                    .bindPopup(`<b>${track.name}</b><br>Start`)
                    .addTo(map);
                mapLayers.push(startMarker);

                // Add end marker
                const endIcon = L.divIcon({
                    className: 'custom-marker end-marker',
                    iconSize: [14, 14],
                    iconAnchor: [7, 7]
                });
                const endMarker = L.marker(coordinates[coordinates.length - 1], { icon: endIcon })
                    .bindPopup(`<b>${track.name}</b><br>End<br>${track.points[track.points.length-1].distance.toFixed(2)} km`)
                    .addTo(map);
                mapLayers.push(endMarker);

                allBounds.push(...coordinates);
            });

            if (allBounds.length > 0) {
                map.fitBounds(allBounds, { padding: [30, 30] });
            }
        }

        function updateChart() {
            if (gpxData.length === 0) {
                if (chart) {
                    chart.destroy();
                    chart = null;
                }
                instructions.textContent = 'Upload GPX files to see the altitude profile.';
                legend.innerHTML = '';
                return;
            }

            instructions.textContent = 'Click on the chart to select two points and calculate the average grade between them.';

            const datasets = gpxData.map((track, index) => ({
                label: track.name,
                data: track.points.map(p => ({ x: p.distance, y: p.elevation })),
                borderColor: track.color,
                backgroundColor: track.color + '20',
                fill: true,
                tension: 0.3,
                pointRadius: 0,
                pointHoverRadius: 6,
                borderWidth: 2,
                trackIndex: index
            }));

            const ctx = document.getElementById('altitudeChart').getContext('2d');

            if (chart) {
                chart.destroy();
            }

            chart = new Chart(ctx, {
                type: 'line',
                data: { datasets: datasets },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'nearest',
                        axis: 'x',
                        intersect: false
                    },
                    onClick: handleChartClick,
                    onHover: handleChartHover,
                    scales: {
                        x: {
                            type: 'linear',
                            title: {
                                display: true,
                                text: 'Distance (km)',
                                color: '#a0aec0'
                            },
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        },
                        y: {
                            title: {
                                display: true,
                                text: 'Elevation (m)',
                                color: '#a0aec0'
                            },
                            ticks: { color: '#a0aec0' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(26, 26, 46, 0.95)',
                            titleColor: '#fff',
                            bodyColor: '#a0aec0',
                            borderColor: '#667eea',
                            borderWidth: 1,
                            callbacks: {
                                title: (items) => items[0]?.dataset.label || '',
                                label: (item) => `Distance: ${item.parsed.x.toFixed(2)} km | Elevation: ${item.parsed.y.toFixed(0)} m`
                            }
                        }
                    }
                }
            });

            // Update legend
            legend.innerHTML = gpxData.map(track => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${track.color}"></div>
                    ${track.name}
                </div>
            `).join('');
        }

        function handleChartHover(event, elements) {
            if (!map || gpxData.length === 0) return;

            // Remove previous hover marker
            if (hoverMarker) {
                map.removeLayer(hoverMarker);
                hoverMarker = null;
            }

            if (elements && elements.length > 0) {
                const element = elements[0];
                const datasetIndex = element.datasetIndex;
                const pointIndex = element.index;
                const track = gpxData[datasetIndex];
                const point = track.points[pointIndex];

                const hoverIcon = L.divIcon({
                    className: 'hover-marker',
                    iconSize: [12, 12],
                    iconAnchor: [6, 6]
                });

                hoverMarker = L.marker([point.lat, point.lon], { icon: hoverIcon }).addTo(map);
            }
        }

        function handleChartClick(event, elements) {
            if (!elements || elements.length === 0) return;

            const element = elements[0];
            const datasetIndex = element.datasetIndex;
            const pointIndex = element.index;
            const dataset = chart.data.datasets[datasetIndex];
            const point = dataset.data[pointIndex];
            const track = gpxData[datasetIndex];
            const trackPoint = track.points[pointIndex];

            const selectedPoint = {
                distance: point.x,
                elevation: point.y,
                lat: trackPoint.lat,
                lon: trackPoint.lon,
                trackName: dataset.label,
                datasetIndex: datasetIndex,
                pointIndex: pointIndex
            };

            if (selectedPoints.length >= 2) {
                selectedPoints = [selectedPoint];
            } else {
                selectedPoints.push(selectedPoint);
            }

            updateSelectionDisplay();
            updateChartAnnotations();
            updateMapSelection();
        }

        function updateMapSelection() {
            if (!map) return;

            // Remove previous selection markers
            selectedMarkers.forEach(m => map.removeLayer(m));
            selectedMarkers = [];

            if (highlightedSegment) {
                map.removeLayer(highlightedSegment);
                highlightedSegment = null;
            }

            selectedPoints.forEach((point, index) => {
                const icon = L.divIcon({
                    className: 'selected-marker',
                    iconSize: [16, 16],
                    iconAnchor: [8, 8]
                });

                const marker = L.marker([point.lat, point.lon], { icon: icon })
                    .bindPopup(`<b>Point ${index + 1}</b><br>Distance: ${point.distance.toFixed(2)} km<br>Elevation: ${point.elevation.toFixed(0)} m`)
                    .addTo(map);
                selectedMarkers.push(marker);
            });

            // Draw highlighted segment between two points
            if (selectedPoints.length === 2) {
                const p1 = selectedPoints[0];
                const p2 = selectedPoints[1];
                
                // Get all points between the two selected points
                const track = gpxData[p1.datasetIndex];
                if (p1.datasetIndex === p2.datasetIndex) {
                    const startIdx = Math.min(p1.pointIndex, p2.pointIndex);
                    const endIdx = Math.max(p1.pointIndex, p2.pointIndex);
                    const segmentPoints = track.points.slice(startIdx, endIdx + 1).map(p => [p.lat, p.lon]);
                    
                    highlightedSegment = L.polyline(segmentPoints, {
                        color: '#ffd700',
                        weight: 6,
                        opacity: 1
                    }).addTo(map);

                    map.fitBounds(segmentPoints, { padding: [50, 50] });
                }
            }
        }

        function updateSelectionDisplay() {
            if (selectedPoints.length === 0) {
                selectionInfo.style.display = 'none';
                clearBtn.style.display = 'none';
                return;
            }

            selectionInfo.style.display = 'grid';
            clearBtn.style.display = 'block';

            const p1 = selectedPoints[0];
            document.getElementById('point1Dist').textContent = p1.distance.toFixed(2);
            document.getElementById('point1Alt').textContent = p1.elevation.toFixed(0);

            if (selectedPoints.length === 2) {
                const p2 = selectedPoints[1];
                document.getElementById('point2Dist').textContent = p2.distance.toFixed(2);
                document.getElementById('point2Alt').textContent = p2.elevation.toFixed(0);

                const distBetween = Math.abs(p2.distance - p1.distance);
                const elevChange = p2.elevation - p1.elevation;
                
                // If p1 is after p2 in distance, flip the elevation change
                const actualElevChange = p2.distance >= p1.distance ? elevChange : -elevChange;
                const grade = distBetween > 0 ? (actualElevChange / (distBetween * 1000)) * 100 : 0;

                document.getElementById('distanceBetween').textContent = distBetween.toFixed(2);
                document.getElementById('elevationChange').textContent = (actualElevChange >= 0 ? '+' : '') + actualElevChange.toFixed(0);
                document.getElementById('averageGrade').textContent = (grade >= 0 ? '+' : '') + grade.toFixed(1);

                const gradeIndicator = document.getElementById('gradeIndicator');
                const absGrade = Math.abs(grade);
                if (absGrade < 3) {
                    gradeIndicator.className = 'grade-indicator grade-flat';
                    gradeIndicator.textContent = 'Flat';
                } else if (absGrade < 6) {
                    gradeIndicator.className = 'grade-indicator grade-moderate';
                    gradeIndicator.textContent = 'Moderate';
                } else if (absGrade < 10) {
                    gradeIndicator.className = 'grade-indicator grade-steep';
                    gradeIndicator.textContent = 'Steep';
                } else {
                    gradeIndicator.className = 'grade-indicator grade-extreme';
                    gradeIndicator.textContent = 'Extreme';
                }
            } else {
                document.getElementById('point2Dist').textContent = '-';
                document.getElementById('point2Alt').textContent = '-';
                document.getElementById('distanceBetween').textContent = '-';
                document.getElementById('elevationChange').textContent = '-';
                document.getElementById('averageGrade').textContent = '-';
                document.getElementById('gradeIndicator').className = 'grade-indicator';
                document.getElementById('gradeIndicator').textContent = '';
            }
        }

        function updateChartAnnotations() {
            if (!chart) return;

            // Update point radius to show selected points
            chart.data.datasets.forEach((dataset, di) => {
                const pointRadii = dataset.data.map((_, pi) => {
                    const isSelected = selectedPoints.some(sp => 
                        sp.datasetIndex === di && sp.pointIndex === pi
                    );
                    return isSelected ? 10 : 0;
                });
                
                const pointColors = dataset.data.map((_, pi) => {
                    const isSelected = selectedPoints.some(sp => 
                        sp.datasetIndex === di && sp.pointIndex === pi
                    );
                    return isSelected ? '#ffd700' : dataset.borderColor;
                });

                dataset.pointRadius = pointRadii;
                dataset.pointBackgroundColor = pointColors;
                dataset.pointBorderColor = pointColors;
            });

            chart.update();
        }

        function clearSelection() {
            selectedPoints = [];
            updateSelectionDisplay();
            
            if (chart) {
                chart.data.datasets.forEach(dataset => {
                    dataset.pointRadius = 0;
                });
                chart.update();
            }

            // Clear map selection
            selectedMarkers.forEach(m => map.removeLayer(m));
            selectedMarkers = [];
            
            if (highlightedSegment) {
                map.removeLayer(highlightedSegment);
                highlightedSegment = null;
            }

            // Reset map view to show all tracks
            if (map && gpxData.length > 0) {
                const allBounds = [];
                gpxData.forEach(track => {
                    track.points.forEach(p => allBounds.push([p.lat, p.lon]));
                });
                map.fitBounds(allBounds, { padding: [30, 30] });
            }
        }

        clearBtn.addEventListener('click', clearSelection);
    </script>
</body>
</html>
